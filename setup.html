<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport" />
  <title>Attenza App - Setup</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0"
    rel="stylesheet" />

  <style>
    /* --- VARIABLES --- */
    :root {
      --bg-body: #F9F8F6;
      --bg-white: #ffffff;
      --bg-gray-light: #f9fafb;
      --bg-card: #ffffff;

      --text-main: #18181b;
      --text-muted: #71717a;
      --text-light: #9ca3af;

      --brand-purple: #6E62E5;
      --brand-purple-light: rgba(110, 98, 229, 0.05);
      --brand-subtle: #EEF2FF;
      --brand-purple-text: #6E62E5;

      --border-color: #f3f4f6;
      --border-light: #E4E4E7;

      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);

      --error-red: #ef4444;
      --error-bg: #FEF2F2;

      --radius-xl: 16px;
      --radius-lg: 12px;
      --radius-md: 8px;
      --radius-pill: 100px;
      --radius-card: 14px;
      --radius-input: 8px;

      --footer-h: 76px;
      --safe-bottom: env(safe-area-inset-bottom, 20px);
    }

    /* --- GLOBAL RESET --- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      position: fixed;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    button,
    input {
      border: none;
      outline: none;
      background: none;
    }

    /* VIEW MANAGEMENT (SPA Logic) */
    .app-view {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--bg-body);
      display: flex;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      z-index: 0;
      transition: opacity 0.3s ease;
    }

    .app-view.active {
      opacity: 1;
      pointer-events: auto;
      z-index: 10;
    }

    /* ANIMATIONS */
    .scale-pop {
      animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes pop {
      0% {
        transform: scale(0.95);
      }

      50% {
        transform: scale(1.02);
      }

      100% {
        transform: scale(1);
      }
    }

    /* =========================================
           SHARED UI ELEMENTS
           ========================================= */
    .nav-btn {
      width: 40px;
      height: 40px;
      border-radius: 30%;
      background: var(--bg-white);
      border: 1px solid var(--border-color);
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: var(--shadow-sm);
    }

    .nav-btn:active {
      background-color: rgba(0, 0, 0, 0.05);
      transform: scale(0.95);
    }

    /* =========================================
           SETUP LAYOUT & HEADER
           ========================================= */
    .persistent-header {
      padding: 24px 20px 0 20px;
      background-color: var(--bg-body);
      z-index: 20;
      flex-shrink: 0;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }

    .nav-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .progress-wrapper {
      margin-bottom: 26px;
    }

    .step-text {
      font-size: 11px;
      font-weight: 700;
      color: var(--brand-purple);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
    }

    .progress-track {
      width: 100%;
      height: 6px;
      background: #E4E4E7;
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--brand-purple);
      border-radius: 10px;
      transition: width 0.3s ease;
    }

    .progress-fill.w-33 {
      width: 33%;
    }

    .progress-fill.w-90 {
      width: 90%;
    }

    /* Scrollable Area for Steps */
    .content-stage {
      flex: 1;
      position: relative;
      overflow: hidden;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
    }

    .step-panel {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow-y: auto;
      padding-bottom: 140px;
      /* Space for fixed action bars */
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      overscroll-behavior: contain;
      width: 100%;
    }

    .step-panel.active {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    /* --- STEP 1 STYLES --- */
    .px-default {
      padding-left: 20px;
      padding-right: 20px;
    }

    .px-grid {
      padding-left: 12px;
      padding-right: 8px;
    }

    .profile-card {
      display: flex;
      gap: 16px;
      margin-bottom: 26px;
      align-items: flex-start;
    }

    .profile-img {
      width: 60px;
      height: 60px;
      border-radius: var(--radius-xl);
      object-fit: cover;
      border: 1px solid white;
      box-shadow: var(--shadow-sm);
      flex-shrink: 0;
    }

    .profile-info {
      height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 1px 0;
      width: 100%;
      overflow: hidden;
      position: relative;
    }

    .profile-name {
      font-size: 17px;
      font-weight: 700;
      line-height: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 20px;
    }

    .profile-email {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .profile-pills {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .pill {
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .pill-purple {
      background: rgba(110, 98, 229, 0.1);
      border: 1px solid rgba(110, 98, 229, 0.1);
      color: var(--brand-purple-text);
    }

    .edit-icon {
      position: absolute;
      bottom: 4px;
      right: 0;
      width: 22px;
      height: 22px;
      cursor: pointer;
      color: #18181b;
      transition: color 0.2s;
    }

    .edit-icon:hover {
      color: var(--brand-purple);
    }

    .context-header {
      margin-bottom: 16px;
    }

    .context-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
      margin-bottom: 4px;
      color: var(--text-main);
    }

    .context-sub {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .search-container {
      position: relative;
      width: 100%;
      margin-bottom: 26px;
      padding-top: 0px;
    }

    .search-container .search-icon {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: #18181b;
      font-size: 24px;
      pointer-events: none;
      z-index: 5;
      transition: color 0.3s;
    }

    .fake-placeholder-layer {
      position: absolute;
      left: 56px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      display: flex;
      align-items: center;
      font-size: 16px;
      font-weight: 500;
      color: #D4D4D8;
      z-index: 1;
    }

    .blinking-cursor {
      color: var(--text-main);
      font-weight: 300;
      margin-right: -1.5px;
      animation: cursorBlink 1s step-end infinite;
    }

    @keyframes cursorBlink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0;
      }
    }

    .search-container .search-input {
      position: relative;
      z-index: 2;
      width: 100%;
      background-color: transparent;
      padding: 10px 12px 10px 38px;
      font-size: 16px;
      font-weight: 500;
      color: var(--text-main);
      border-bottom: 2px solid #18181b;
      border-radius: 0;
      transition: border-color 0.3s ease;
    }

    .search-container .search-input:focus {
      border-bottom-color: var(--brand-purple);
    }

    .search-container .search-input:focus~.search-icon {
      color: var(--brand-purple);
    }

    .search-container .search-input:focus+.fake-placeholder-layer,
    .search-container .search-input:not(:placeholder-shown)+.fake-placeholder-layer {
      opacity: 0;
      visibility: hidden;
    }

    .pill-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-content: flex-start;
      width: 100%;
    }

    .subject-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 11px;
      background: var(--bg-white);
      border: 1px solid #e4e4e7;
      border-radius: var(--radius-pill);
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .pill-text {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
    }

    .pill-icon {
      font-size: 16px;
      color: var(--text-light);
    }

    .subject-pill.active {
      background: var(--brand-purple-light);
      border-color: var(--brand-purple);
    }

    .subject-pill.active .pill-text,
    .subject-pill.active .pill-icon {
      color: var(--brand-purple);
    }

    .subject-pill.create-mode {
      border: 1px dashed var(--text-muted);
      background: transparent;
    }

    .missing-footer {
      width: 100%;
      text-align: center;
      margin-top: 20px;
      color: var(--text-light);
      font-size: 13px;
      font-weight: 500;
    }

    /* --- STEP 2 STYLES --- */
    .page-title {
      font-size: 22px;
      font-weight: 700;
      color: #09090b;
      margin-bottom: 4px;
      letter-spacing: -0.02em;
    }

    .page-subtitle {
      font-size: 15px;
      color: var(--text-muted);
      line-height: 1.5;
      margin-bottom: 16px;
    }

    .tip-banner {
      background-color: #F5F3FF;
      border: 1px dashed #DDD6FE;
      border-radius: 12px;
      padding: 8px 12px;
      display: flex;
      gap: 12px;
      align-items: start;
      margin-bottom: 28px;
    }

    .tip-banner .icon {
      color: #6366F1;
      font-size: 20px;
      margin-top: 1px;
    }

    .tip-banner p {
      font-size: 13px;
      line-height: 1.5;
      color: #4B5563;
    }

    .tip-banner b {
      color: #4F46E5;
      font-weight: 600;
    }

    .card-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .subject-card {
      background: var(--bg-card);
      border: 1.6px solid var(--border-light);
      border-radius: var(--radius-card);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
      transition: all 0.2s ease;
    }

    .subject-card:focus-within {
      border-color: var(--brand-purple);
      box-shadow: 0 4px 12px rgba(110, 98, 229, 0.08);
    }

    .card-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 0;
    }

    .subject-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
      white-space: normal;
      line-height: 1.3;
    }

    .pct-badge {
      align-self: flex-start;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      background: #F3F4F6;
      color: #9CA3AF;
    }

    .pct-badge.active {
      background: var(--brand-subtle);
      color: var(--brand-purple);
    }

    .pct-badge.error {
      background: var(--error-bg);
      color: var(--error-red);
    }

    .input-cluster {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      flex-shrink: 0;
    }

    .input-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .num-input {
      width: 50px;
      height: 40px;
      background: #F9F8F6;
      border: 1.6px solid #E4E4E7;
      border-radius: var(--radius-input);
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: #09090b;
      transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
    }

    .num-input::placeholder {
      color: #D4D4D8;
    }

    .num-input:focus {
      border-color: var(--brand-purple);
      box-shadow: 0 0 0 3px rgba(110, 98, 229, 0.15);
      transform: translateY(-1px);
    }

    .num-input.error {
      border-color: var(--error-red);
      background: var(--error-bg);
      color: var(--error-red);
    }

    .input-label {
      font-size: 10px;
      color: var(--text-muted);
      font-weight: 500;
      text-transform: none;
      text-align: center;
      line-height: 1.2;
      white-space: nowrap;
    }

    /* =========================================
           ACTION BARS (Fixed to Body)
           ========================================= */
    .fixed-layer {
      position: fixed;
      bottom: calc(30px + var(--safe-bottom));
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      transform: translateY(120px);
      z-index: 100;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      pointer-events: none;
    }

    .fixed-layer.visible {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .action-bar {
      background-color: #0F0F11;
      color: white;
      padding: 6px 6px 6px 24px;
      border-radius: 100px;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
      min-width: 260px;
      justify-content: space-between;
    }

    .btn-continue-pill {
      background-color: #ffffff;
      color: #0F0F11;
      border: none;
      padding: 12px 24px;
      border-radius: 100px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    .selection-count {
      font-size: 16px;
    }

    .fab-content {
      background-color: #000;
      padding: 6px 6px 6px 24px;
      border-radius: var(--radius-pill);
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 16px 32px -8px rgba(0, 0, 0, 0.3);
      width: 72%;
      max-width: 340px;
      pointer-events: auto;
      backdrop-filter: blur(10px);
    }

    .status-msg {
      font-size: 13px;
      font-weight: 500;
      margin-left: -6px;
      color: #fff;
    }

    .status-msg.active {
      color: #fff;
    }

    .btn-primary {
      background-color: #fff;
      color: #000;
      padding: 14px 20px;
      border-radius: var(--radius-pill);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      line-height: 1;
      white-space: nowrap;
    }

    .btn-primary.save {
      background-color: #ffffff;
      color: #000;
    }
  </style>
</head>

<body>

  <div id="view-setup" class="app-view active">
    <div class="persistent-header">
      <div class="nav-header">
        <button class="nav-btn" onclick="handleBackNavigation()">
          <span class="material-symbols-rounded">arrow_back</span>
        </button>
        <button class="nav-btn">
          <span class="material-symbols-rounded" style="color: var(--brand-purple);">help</span>
        </button>
      </div>

      <div class="progress-wrapper">
        <div class="step-text" id="stepText">Step 1 of 3</div>
        <div class="progress-track">
          <div id="progressFill" class="progress-fill w-33"></div>
        </div>
      </div>
    </div>

    <div class="content-stage">
      <div id="step1-panel" class="step-panel active">
        <div class="profile-card px-default">
          <img id="profileImage"
            src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
            class="profile-img" alt="profile">
          <div class="profile-info">
            <h2 id="profileName" class="profile-name">Johnathan Doe</h2>
            <p id="profileEmail" class="profile-email">john.doe23@university.edu</p>
            <div class="profile-pills">
              <span id="pillRoll" class="pill pill-purple">Roll - 234</span>
              <span id="pillClass" class="pill pill-purple">B.Com 1st Sem</span>
            </div>
            <svg id="editProfileBtn" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="edit-icon">
              <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
              <path d="M13.5 6.5l4 4" />
            </svg>
          </div>
        </div>

        <div class="context-header px-default">
          <h1 class="context-title">Choose your subjects</h1>
          <p class="context-sub">Select or create the subjects for your current class session</p>
        </div>

        <div class="search-container px-default">
          <input type="text" id="subjectInput" placeholder=" " class="search-input" oninput="handleSearch()">
          <div class="fake-placeholder-layer">
            <span class="blinking-cursor">|</span>Type subject name to create
          </div>
          <span class="material-symbols-rounded search-icon">search</span>
        </div>

        <div id="gridContainer" class="pill-grid px-grid"></div>
        <div class="missing-footer">Missing subject? Create to add</div>
      </div>

      <div id="step2-panel" class="step-panel">
        <div style="padding: 16px 20px 0;">
          <h1 class="page-title">Add past attendance</h1>
          <p class="page-subtitle">If you’ve attended classes already for this session, add those records here</p>

          <div class="tip-banner">
            <span class="material-symbols-rounded icon">lightbulb</span>
            <p>You can find past records on your <b>college portal</b>, check with your <b>HOD</b>, or enter a rough
              estimate.</p>
          </div>

          <div id="cardsList" class="card-list"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="actionBar" class="fixed-layer">
    <div class="action-bar">
      <span class="selection-count" id="countText">0 selected</span>
      <button class="btn-continue-pill" onclick="completeStep1()">Continue</button>
    </div>
  </div>

  <div id="fabContainer" class="fixed-layer">
    <div class="fab-content">
      <span class="status-msg" id="statusText">No past records?</span>
      <button class="btn-primary" id="actionBtn" onclick="finishSetup()">Skip step</button>
    </div>
  </div>

  <!-- ===== FIREBASE + APP LOGIC (module) ===== -->
  <script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      setDoc,
      writeBatch,
      runTransaction,
      serverTimestamp,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- FIREBASE CONFIG (same as login.html) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDbFEWKJylJJgNw0KIyFsDxlDKPwJII73o",
      authDomain: "attenza-app.firebaseapp.com",
      projectId: "attenza-app",
      storageBucket: "attenza-app.firebasestorage.app",
      messagingSenderId: "435010148378",
      appId: "1:435010148378:web:e5540806fd0ef90b16d9a3"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ----------------- APP STATE -----------------
    const APP_STATE = {
      uid: null,
      profile: null,
      collegeId: null,
      fetchedSubjects: [
        "Financial Accounting", "Business Law", "Micro Economics",
        "Communicative English", "Business Stats", "Cost Accounting",
        "Marketing Management", "Corporate Law", "Indian Economy",
        "IT in Business", "Entrepreneurship", "Auditing"
      ],
      selectedSubjects: new Set(),
      customSubjects: new Set(),
      step2Data: {}, // id -> { total, attended, touched }
      existingSubjectsMap: {} // docId -> { name, pastAttendance }
    };

    // DOM refs
    const grid = document.getElementById('gridContainer');
    const input = document.getElementById('subjectInput');
    const actionBar = document.getElementById('actionBar');
    const countText = document.getElementById('countText');
    const listContainer = document.getElementById('cardsList');
    const actionBtn = document.getElementById('actionBtn');
    const statusText = document.getElementById('statusText');
    const fabContainer = document.getElementById('fabContainer');
    const profileImage = document.getElementById('profileImage');
    const profileName = document.getElementById('profileName');
    const profileEmail = document.getElementById('profileEmail');
    const pillRoll = document.getElementById('pillRoll');
    const pillClass = document.getElementById('pillClass');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const progressFill = document.getElementById('progressFill');

    // Canvas for measuring text (packing)
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    ctx.font = "600 13px Inter, sans-serif";

    // ---------- Helpers ----------
    function slugifyName(name) {
      return encodeURIComponent(name.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]/g, ''));
    }

    function showToast(msg) {
      alert(msg); // Simple for now — replace with non-blocking UI if desired
    }

    function setProfileUI(profile) {
      if (!profile) return;
      profileName.textContent = profile.name || profile.displayName || "No name";
      profileEmail.textContent = profile.email || "";
      pillRoll.textContent = profile.rollNumber ? `Roll - ${profile.rollNumber}` : "No roll";
      pillClass.textContent = profile.course_or_class || profile.class || "Class not set";
      // if user has a photoURL, show it (we fallback to default)
      if (profile.photoURL) profileImage.src = profile.photoURL;
    }

    // ---------- AUTH + INITIAL LOAD ----------
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // Not signed in — redirect to login
        window.location.replace("login.html");
        return;
      }
      APP_STATE.uid = user.uid;
      await initialLoadForUser();
    });

    async function initialLoadForUser() {
      try {
        // 1) Read user profile doc
        const userRef = doc(db, 'users', APP_STATE.uid);
        const userSnap = await getDoc(userRef);
        let profileData = null;
        if (userSnap.exists()) {
          profileData = userSnap.data();
        } else {
          // minimal profile from auth
          const au = auth.currentUser;
          profileData = {
            name: au.displayName || "",
            email: au.email || "",
            rollNumber: "",
            course_or_class: "",
            college: ""
          };
        }
        APP_STATE.profile = profileData;
        APP_STATE.collegeId = (profileData.college || "").toString().toLowerCase().replace(/\s+/g, '-');
        setProfileUI(profileData);

        // 2) Fetch college-level subject list if available in Firestore
        await loadCollegeSubjects(APP_STATE.collegeId);

        // 3) Fetch existing user subjects collection (if user already saved some)
        await loadUserSubjects();

        // 4) Render grid with current fetched list
        renderGrid(input.value || '');

      } catch (err) {
        console.error("Initial load failed:", err);
        showToast("Connection error while loading your data. Try again.");
      }
    }

    // Attempt to fetch subjects from colleges/{collegeId}/subjects collection if it exists.
    async function loadCollegeSubjects(collegeId) {
      if (!collegeId) return;
      try {
        const colRef = collection(db, 'colleges', collegeId, 'subjects');
        const snaps = await getDocs(colRef);
        if (snaps && !snaps.empty) {
          const arr = [];
          snaps.forEach(s => {
            const d = s.data();
            if (d && d.name) arr.push(d.name);
          });
          if (arr.length) {
            APP_STATE.fetchedSubjects = Array.from(new Set([...arr]));
          }
        }
      } catch (err) {
        // no college subjects or permission issue — fallback to default list
        console.warn("Could not load college subjects", err);
      }
    }

    // Load user's existing saved subjects (and prefill selection + past attendance for step2)
    async function loadUserSubjects() {
      try {
        const subjectsRef = collection(db, 'users', APP_STATE.uid, 'subjects');
        const snaps = await getDocs(subjectsRef);
        if (snaps && !snaps.empty) {
          snaps.forEach(s => {
            const d = s.data() || {};
            APP_STATE.existingSubjectsMap[s.id] = d;
            const name = d.name;
            if (name) {
              APP_STATE.selectedSubjects.add(name);
              // Create step2Data object
              const id = slugifyName(name);
              const past = d.pastAttendance || { total: 0, attended: 0 };
              APP_STATE.step2Data[id] = { total: past.total || 0, attended: past.attended || 0, touched: !!(past.total || past.attended) };
              // Also store map so we can avoid duplicate writes
            }
          });
        }
      } catch (err) {
        console.warn("Failed to read user subjects", err);
      }
    }

    // ---------- UI: GRID RENDERING (same packing logic you used) ----------
    new ResizeObserver(() => {
      if (document.getElementById('step1-panel').classList.contains('active')) {
        renderGrid(input.value);
      }
    }).observe(grid);

    function handleSearch() { renderGrid(input.value); }

    function renderGrid(query = "") {
      const containerWidth = Math.max(120, grid.getBoundingClientRect().width);
      grid.innerHTML = "";
      const q = (query || "").toLowerCase().trim();

      // Use combined set of college fetched subjects + custom subjects + existing selected names
      let allSubjects = new Set([...APP_STATE.fetchedSubjects, ...APP_STATE.customSubjects, ...Object.values(APP_STATE.existingSubjectsMap).map(s => s.name)]);
      let filteredList = Array.from(allSubjects).filter(sub => sub && sub.toLowerCase().includes(q));

      // Default: sort selected first (so selected are visible)
      let allItems = filteredList.map(name => ({ name, width: ctx.measureText(name).width + 70, isSelected: APP_STATE.selectedSubjects.has(name) }));
      let selected = allItems.filter(i => i.isSelected);
      let unselected = allItems.filter(i => !i.isSelected);
      let pool = [...selected, ...unselected];

      // pack
      const packed = packItemsDense(pool, containerWidth);
      packed.forEach(item => grid.appendChild(createPill(item.name, false)));

      if (q.length > 0 && !filteredList.some(s => s.toLowerCase() === q)) {
        // show create pill
        grid.appendChild(createPill(query.trim(), true));
      }

      updateStep1Action();
    }

    function packItemsDense(items, containerWidth) {
      let packedRows = [];
      let pool = [...items];
      const GAP = 8;
      const availableSpace = containerWidth - 16;

      while (pool.length > 0) {
        let row = [];
        let firstItem = pool.shift();
        row.push(firstItem);
        let remainingSpace = availableSpace - firstItem.width;
        while (remainingSpace > 0 && pool.length > 0) {
          let bestMatchIndex = -1;
          let bestMatchSize = 0;
          for (let i = 0; i < pool.length; i++) {
            let totalW = pool[i].width + GAP;
            if (totalW <= remainingSpace && totalW > bestMatchSize) {
              bestMatchSize = totalW; bestMatchIndex = i;
            }
          }
          if (bestMatchIndex !== -1) {
            let matched = pool.splice(bestMatchIndex, 1)[0];
            row.push(matched);
            remainingSpace -= (matched.width + GAP);
          } else break;
        }
        packedRows.push(row);
      }
      return packedRows.flat();
    }

    function createPill(name, isCreationMode) {
      const el = document.createElement('div');
      el.className = `subject-pill scale-pop ${APP_STATE.selectedSubjects.has(name) ? 'active' : ''} ${isCreationMode ? 'create-mode' : ''}`;
      el.innerHTML = `<span class="pill-text">${isCreationMode ? 'Create "' + name + '"' : name}</span>
                      <span class="material-symbols-rounded pill-icon">${APP_STATE.selectedSubjects.has(name) ? 'check' : 'add'}</span>`;

      el.onclick = () => {
        if (isCreationMode) {
          APP_STATE.customSubjects.add(name);
          APP_STATE.selectedSubjects.add(name);
          // prefill step2Data
          const id = slugifyName(name);
          APP_STATE.step2Data[id] = APP_STATE.step2Data[id] || { total: 0, attended: 0, touched: false };
          input.value = "";
        } else {
          if (APP_STATE.selectedSubjects.has(name)) {
            APP_STATE.selectedSubjects.delete(name);
            // optionally remove step2Data? keep it so if they reselect it's preserved
          } else {
            APP_STATE.selectedSubjects.add(name);
            const id = slugifyName(name);
            APP_STATE.step2Data[id] = APP_STATE.step2Data[id] || { total: 0, attended: 0, touched: false };
          }
        }
        handleSearch();
        updateStep1Action();
      };
      return el;
    }

    function updateStep1Action() {
      const count = APP_STATE.selectedSubjects.size;
      countText.innerText = `${count} selected`;
      if (count > 0 && APP_STATE.currentView !== 'step2') {
        actionBar.classList.add('visible');
      } else {
        actionBar.classList.remove('visible');
      }
    }

    // ---------- Step navigation ----------
    function navigateTo(viewId) {
      APP_STATE.currentView = viewId;
      if (viewId === 'step1') showStep(1);
      else if (viewId === 'step2') {
        showStep(2);
        initStep2();
      }
    }

    function showStep(stepNum) {
      const panel1 = document.getElementById('step1-panel');
      const panel2 = document.getElementById('step2-panel');
      const label = document.getElementById('stepText');

      if (stepNum === 1) {
        panel1.classList.add('active');
        panel2.classList.remove('active');
        label.innerText = "Step 1 of 3";
        progressFill.style.width = "33%";
        actionBar.classList.toggle('visible', APP_STATE.selectedSubjects.size > 0);
        fabContainer.classList.remove('visible');
      } else {
        panel1.classList.remove('active');
        panel2.classList.add('active');
        label.innerText = "Step 2 of 2";
        progressFill.style.width = "90%";
        actionBar.classList.remove('visible');
        fabContainer.classList.add('visible');
      }
    }

    function handleBackNavigation() {
      if (APP_STATE.currentView === 'step2') navigateTo('step1');
      else window.location.replace('index.html'); // exit flow
    }

    function completeStep1() {
      if (APP_STATE.selectedSubjects.size === 0) {
        showToast('Please select at least one subject to continue.');
        return;
      }
      navigateTo('step2');
    }

    // ---------- Step 2: render cards for selected subjects and attach inputs ----------
    function initStep2() {
      listContainer.innerHTML = '';
      // ensure step2Data has entries for each selected subject
      const subjectsArr = Array.from(APP_STATE.selectedSubjects);
      if (subjectsArr.length === 0) {
        listContainer.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding: 20px;">No subjects selected in Step 1</div>';
        updateStep2Action();
        return;
      }

      subjectsArr.forEach((sub, index) => {
        const id = slugifyName(sub);
        if (!APP_STATE.step2Data[id]) APP_STATE.step2Data[id] = { total: 0, attended: 0, touched: false };

        const existing = APP_STATE.step2Data[id];
        const card = document.createElement('div');
        card.className = 'subject-card';
        card.innerHTML = `
          <div class="card-content">
            <span class="subject-title">${sub}</span>
            <span class="pct-badge" id="badge-${id}">${existing.total > 0 ? Math.round((existing.attended / existing.total) * 100) + '%' : '0%'}</span>
          </div>
          <div class="input-cluster">
            <div class="input-wrapper">
              <input type="tel" inputmode="numeric" pattern="[0-9]*" class="num-input" id="total-${id}" placeholder="0"
                value="${existing.total || ''}" oninput="window.updateCalc('${id}')" onclick="this.select()">
              <span class="input-label">Total<br>classes</span>
            </div>
            <div class="input-wrapper">
              <input type="tel" inputmode="numeric" pattern="[0-9]*" class="num-input" id="attended-${id}" placeholder="0"
                value="${existing.attended || ''}" oninput="window.updateCalc('${id}')" onclick="this.select()">
              <span class="input-label">Attended<br>classes</span>
            </div>
          </div>
        `;
        listContainer.appendChild(card);
        // initial calc
        updateCalc(id);
      });
      updateStep2Action();
    }

    window.updateCalc = function (id) {
      const totalEl = document.getElementById(`total-${id}`);
      const attendedEl = document.getElementById(`attended-${id}`);
      const badge = document.getElementById(`badge-${id}`);
      if (!totalEl || !attendedEl || !badge) return;

      // allow only numbers
      totalEl.value = totalEl.value.replace(/[^0-9]/g, '');
      attendedEl.value = attendedEl.value.replace(/[^0-9]/g, '');

      const total = parseInt(totalEl.value) || 0;
      const attended = parseInt(attendedEl.value) || 0;

      APP_STATE.step2Data[id].touched = (totalEl.value !== "" || attendedEl.value !== "");
      APP_STATE.step2Data[id].total = total;
      APP_STATE.step2Data[id].attended = attended;

      if (attended > total && total > 0) {
        attendedEl.classList.add('error');
        badge.className = "pct-badge error";
        badge.innerText = "Error";
      } else {
        attendedEl.classList.remove('error');
        if (total > 0) {
          const pct = Math.round((attended / total) * 100);
          badge.className = "pct-badge active";
          badge.innerText = `${pct}%`;
        } else {
          badge.className = "pct-badge";
          badge.innerText = "0%";
        }
      }
      updateStep2Action();
    }

    function updateStep2Action() {
      if (APP_STATE.currentView !== 'step2') return;

      const values = Object.values(APP_STATE.step2Data || {});
      const validEntries = values.filter(d => d.touched && d.total > 0 && d.attended <= d.total).length;
      const anyInput = values.some(d => d.touched);

      if (anyInput) {
        statusText.innerText = validEntries > 0 ? `${validEntries} subject${validEntries !== 1 ? 's' : ''} updated` : "Entering data...";
        statusText.classList.add('active');
        actionBtn.innerText = "Continue";
        actionBtn.classList.add('save');
      } else {
        statusText.innerText = "No past records?";
        statusText.classList.remove('active');
        actionBtn.innerText = "Skip step";
        actionBtn.classList.remove('save');
      }
    }

    // ---------- FINISH / SAVE LOGIC ----------
    async function finishSetup() {
      // If save mode (user entered data), validate and write. If skip, still write selected subjects without past data.
      const savingPast = actionBtn.classList.contains('save');
      // Basic validation
      let hasErrors = false;
      Object.values(APP_STATE.step2Data).forEach(d => { if (d.attended > d.total) hasErrors = true; });
      if (hasErrors) {
        showToast("One or more subjects have attended > total. Fix before continuing.");
        return;
      }

      // Prepare writes: for each selected subject write or update users/{uid}/subjects/{subjectId}
      try {
        const batch = writeBatch(db);
        const selected = Array.from(APP_STATE.selectedSubjects);
        let pastTotalSum = 0;
        let pastAttendedSum = 0;

        selected.forEach(name => {
          const id = slugifyName(name);
          const subjectRef = doc(db, 'users', APP_STATE.uid, 'subjects', id);
          // Build payload
          const past = APP_STATE.step2Data[id] || { total: 0, attended: 0 };
          if (past.total) {
            pastTotalSum += past.total;
            pastAttendedSum += past.attended;
          }
          const payload = {
            name: name,
            pastAttendance: { total: past.total || 0, attended: past.attended || 0 },
            updatedAt: serverTimestamp()
          };
          // If it existed earlier, we merge; otherwise create new
          batch.set(subjectRef, payload, { merge: true });
        });

        // commit subjects write
        await batch.commit();

        // Now update summary doc inside a transaction so we don't overwrite other fields
        const summaryRef = doc(db, 'users', APP_STATE.uid, 'metadata', 'summary'); // choose metadata/summary path
        await runTransaction(db, async (tx) => {
          const summarySnap = await tx.get(summaryRef);
          const existing = summarySnap.exists() ? summarySnap.data() : {};

          // We'll set past totals (derived from subjects) so it's authoritative for past data.
          // Keep other fields such as appTracked totals untouched.
          const newSummary = {
            pastTotalClasses: pastTotalSum,
            pastAttendedClasses: pastAttendedSum,
            updatedAt: serverTimestamp()
          };

          // Merge with existing
          tx.set(summaryRef, { ...existing, ...newSummary }, { merge: true });
        });

        showToast("Subjects saved successfully!");
        // redirect to index/dashboard
        window.location.replace("index.html");
      } catch (err) {
        console.error("Saving failed:", err);
        showToast("Failed to save. Check internet connection and try again.");
      }
    }

    // Expose functions to window for inline HTML handlers
    window.handleSearch = handleSearch;
    window.completeStep1 = completeStep1;
    window.handleBackNavigation = handleBackNavigation;
    window.finishSetup = finishSetup;

    // initialize first render
    window.addEventListener('DOMContentLoaded', () => {
      // if user already signed in, onAuthStateChanged will trigger initialLoadForUser
      renderGrid('');
      updateStep1Action();
    });
  </script>
</body>

</html>