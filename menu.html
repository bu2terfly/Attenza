<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
    <title>Attenza App - Menu</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />

    <style>
        /* --- VARIABLES (Original + Result Card Additions) --- */
        :root {
            /* Original Menu Variables */
            --bg-body: #F9F8F6;
            --bg-white: #ffffff;
            --bg-gray-light: #f9fafb;
            --bg-card: #ffffff;
            --text-main: #18181b;
            --text-muted: #71717a;
            --text-light: #9ca3af;
            --brand-purple: #6E62E5; 
            --brand-purple-light: rgba(110, 98, 229, 0.05);
            --brand-subtle: #EEF2FF;
            --brand-purple-text: #6E62E5;
            --border-color: #f3f4f6;
            --border-light: #E4E4E7;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --radius-xl: 16px;
            --radius-lg: 12px;
            --radius-md: 8px;
            --radius-pill: 100px;
            --safe-bottom: env(safe-area-inset-bottom, 20px);

            /* Added for Result Card (Matches Original Aesthetic) */
            --primary-accent: #6E62E5; /* Synced with brand-purple */
            --primary-soft: #EEF2FF;
            --shadow-float: 0 10px 25px -5px rgba(0, 0, 0, 0.06), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            --shadow-dropdown: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* --- GLOBAL RESET --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        /* IFRAME-SAFE body: use min-height & relative positioning (fixes layout inside iframe) */
        body { background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; width: 100%; overflow: hidden; position: relative; }
        a { text-decoration: none; color: inherit; }
        button, input { border: none; outline: none; background: none; }

        /* VIEW MANAGEMENT */
        .app-view {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-body);
            display: flex;
            flex-direction: column;
            opacity: 1; 
            pointer-events: auto;
            z-index: 10;
        }

        /* --- HEADER SECTION (Z-Index High to stay sharp) --- */
        .container-top { 
            padding: 24px 20px 8px 20px; 
            flex-shrink: 0; 
            z-index: 102; /* Above the overlay */
            position: relative;
            background-color: var(--bg-body); /* Ensure opacity */
        }
        
        /* --- SCROLL SECTION (Z-Index Low to get blurred) --- */
        .container-scroll { 
            flex: 1; 
            overflow-y: auto; 
            padding: 0 20px 40px 20px; 
            overscroll-behavior: contain;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            transform-origin: top center;
        }
        .container-scroll::-webkit-scrollbar { display: none; }

        /* THE BLUR CLASS (Applied via JS) */
        .container-scroll.content-blurred {
            filter: blur(8px) grayscale(60%);
            transform: scale(0.98);
            opacity: 0.8;
            pointer-events: none; /* Disable clicks on menu when searching */
        }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .header-title { font-size: 20px; font-weight: 700; }
        
        .nav-btn { width: 40px; height: 40px; border-radius: 30%; background: var(--bg-white); border: 1px solid var(--border-color); color: var(--text-main); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; box-shadow: var(--shadow-sm); }
        .nav-btn:active { background-color: rgba(0,0,0,0.05); transform: scale(0.95); }

        /* --- ENHANCED SEARCH BOX --- */
        .search-box { position: relative; width: 100%; margin-bottom: 0px; transition: all 0.3s ease; }
        
        .search-box .search-icon { 
            position: absolute; left: 16px; top: 50%; transform: translateY(-50%); 
            color: var(--text-light); font-size: 20px; 
            transition: opacity 0.2s; 
        }

        /* Prefix "Roll –" */
        .search-prefix {
            position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
            font-size: 14px; font-weight: 600; color: var(--text-main);
            pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }

        .search-box .search-input { 
            width: 100%; 
            background-color: var(--bg-white); 
            padding: 14px 16px 14px 44px; 
            border-radius: var(--radius-lg); 
            font-size: 14px; 
            font-weight: 500; 
            box-shadow: var(--shadow-sm); 
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }
        .search-box .search-input::placeholder { color: var(--text-light); transition: opacity 0.2s; }
        .search-box .search-input:focus { box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1); border-color: var(--brand-purple); }

        /* Search Active States */
        .search-box.active .search-icon { opacity: 0; }
        .search-box.active .search-prefix { opacity: 1; }
        .search-box.active .search-input { padding-left: 60px; /* Space for Roll - */ }
        .search-box.active .search-input::placeholder { opacity: 0; }

        /* Right Arrow Action Button */
        .search-action-btn {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%) scale(0.5);
            width: 32px; height: 32px;
            background-color: var(--brand-purple);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; cursor: pointer;
            opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 2px 6px rgba(110, 98, 229, 0.3);
        }
        .search-action-btn.visible { opacity: 1; transform: translateY(-50%) scale(1); pointer-events: auto; }
        .search-action-btn svg { width: 18px; height: 18px; stroke-width: 2.5; }

        /* --- ORIGINAL MENU ITEMS STYLING --- */
        .menu-profile-card { display: flex; gap: 16px; margin-top: 36px; margin-bottom: 16px; align-items: flex-start; }
        .menu-profile-img { width: 65px; height: 65px; border-radius: var(--radius-xl); object-fit: cover; border: 1px solid white; box-shadow: var(--shadow-sm); flex-shrink: 0; }
        .menu-profile-info { height: 65px; display: flex; flex-direction: column; justify-content: space-between; padding: 2px 0; width: 100%; overflow: hidden; position: relative; }
        .menu-profile-name { font-size: 18px; font-weight: 700; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 20px; }
        .menu-profile-email { font-size: 12px; font-weight: 500; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .profile-pills { display: flex; gap: 8px; align-items: center; }
        .pill { padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .pill-purple { background: rgba(110, 98, 229, 0.1); border: 1px solid rgba(110, 98, 229, 0.1); color: var(--brand-purple-text); }
        .edit-icon { position: absolute; bottom: 4px; right: 0; width: 22px; height: 22px; cursor: pointer; color: #18181b; transition: color 0.2s; }
        .edit-icon:hover { color: var(--brand-purple); }
        
        .menu-card { background: var(--bg-white); border-radius: var(--radius-xl); box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); overflow: hidden; margin-bottom: 20px; }
        .menu-header { background-color: #F9FAFB; padding: 8px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .menu-header-text { font-size: 11px; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.1em; }

        .menu-item { display: flex; align-items: center; padding: 14px 16px; transition: background 0.2s; cursor: pointer; position: relative; }
        .menu-item:hover { background-color: var(--bg-gray-light); }
        .menu-item.active { background-color: var(--brand-purple-light); border-left: 3px solid var(--brand-purple); padding-left: 13px; }
        .menu-item.active:hover { background-color: rgba(110, 98, 229, 0.1); }

        .menu-icon-box { width: 32px; height: 32px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0; }
        .menu-icon-box.purple-bg { background-color: var(--brand-purple); color: white; box-shadow: var(--shadow-sm); }
        .menu-text { flex: 1; }
        .menu-title { font-size: 16px; font-weight: 700; color: var(--text-main); margin-bottom: 2px; }
        .menu-subtitle { font-size: 11px; font-weight: 500; color: var(--brand-purple-text); }
        .menu-item-text { flex: 1; font-size: 13px; font-weight: 500; color: var(--text-main); }
        .menu-icon_gray, .menu-icon-gray { color: var(--text-light); font-size: 20px; margin-right: 12px; }

        .chevron { color: #d1d5db; font-size: 18px; }
        .chevron-active { color: var(--brand-purple-text); font-size: 20px; }
        .divider { height: 1px; background-color: var(--border-color); margin: 0 16px; }

        .status-dot { position: absolute; top: 8px; right: 8px; width: 6px; height: 6px; background-color: rgb(255, 0, 0); border-radius: 50%; z-index: 10; box-shadow: 0 0 4px rgba(255, 0, 0, 0.5); }
        .status-dot::before { content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 1px; height: 1px; background-color: rgb(255, 0, 0); border-radius: 50%; animation: pulse-loop 1.5s infinite ease-out; }
        @keyframes pulse-loop { 0% { background-color: rgba(255, 0, 0, 1); width: 1px; height: 1px; } 100% { background-color: rgba(255, 0, 0, 0); width: 20px; height: 20px; } }

        .logout-section { margin-top: 36px; text-align: center; padding-bottom: 20px; }
        .btn-logout { width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; color: #ef4444; font-weight: 600; font-size: 14px; cursor: pointer; transition: opacity 0.2s; }
        .btn-logout:hover { opacity: 0.75; }
        .version-text { text-align: center; margin-top: 12px; font-size: 10px; color: #d1d5db; }

        /* --- RESULT OVERLAY CONTAINER (Inserted logic) --- */
        #result-overlay-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 101; /* Middle Layer: Below Header (102), Above Content (1) */
            display: none; 
            justify-content: center;
            padding-top: 140px; 
            pointer-events: none;
        }

        .overlay-backdrop {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255, 0.01); 
            z-index: 1; pointer-events: auto;
        }

        .result-wrapper {
            position: relative; z-index: 10; width: 100%; max-width: 400px;
            padding: 0 20px;
            animation: slideDown 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            pointer-events: auto;
        }

        /* Result Components (Matches your UI requirement) */
        .result-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 0 4px; }
        .helper-text { font-size: 13px; color: var(--text-muted); font-weight: 500; }
        
        .dropdown-wrapper { position: relative; }
        .class-pill { background-color: var(--primary-soft); color: var(--primary-accent); padding: 8px 12px; border-radius: 30px; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 6px; cursor: pointer; transition: all 0.2s; letter-spacing: 0.3px; user-select: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .class-pill:active { opacity: 0.7; transform: scale(0.98); }
        .class-pill svg { width: 18px; height: 18px; stroke-width: 2.5; transition: transform 0.2s; }
        .dropdown-wrapper.active .class-pill svg { transform: rotate(180deg); }
        
        .dropdown-list { position: absolute; right: 0; top: 120%; width: 180px; background: var(--bg-white); border-radius: 16px; box-shadow: var(--shadow-dropdown); border: 1px solid var(--border-light); z-index: 50; overflow: hidden; opacity: 0; transform: translateY(-10px); pointer-events: none; transition: all 0.2s ease; }
        .dropdown-wrapper.active .dropdown-list { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .dropdown-item { padding: 12px 16px; font-size: 13px; font-weight: 500; color: var(--text-main); border-bottom: 1px solid var(--border-light); cursor: pointer; transition: background 0.2s; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background-color: var(--primary-soft); color: var(--primary-accent); }

        .result-card { background: var(--bg-white); border-radius: 20px; padding: 18px; box-shadow: var(--shadow-float); border: 1px solid var(--border-light); display: flex; align-items: center; justify-content: space-between; }
        .card-left { display: flex; align-items: center; gap: 14px; }
        .avatar-box { width: 42px; height: 42px; background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); }
        .info-group { display: flex; flex-direction: column; gap: 3px; }
        .student-name { font-size: 16px; font-weight: 600; color: var(--text-main); letter-spacing: -0.3px; }
        .data-freshness { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; }
        .status-dot-result { width: 6px; height: 6px; background-color: #10B981; border-radius: 50%; }
        .card-right { text-align: right; }
        .percentage-val { font-size: 22px; font-weight: 700; color: var(--primary-accent); font-feature-settings: "tnum"; line-height: 1; margin-bottom: 0px; display: block; }
        .percentage-label { font-size: 12px; font-weight: 600; color: var(--text-muted); letter-spacing: 0.5px; }

        .empty-card { background: var(--bg-white); border-radius: 20px; padding: 30px 20px; text-align: center; box-shadow: var(--shadow-float); border: 1px solid var(--border-light); display: none; animation: fadeIn 0.3s ease; }
        .empty-icon { width: 48px; height: 48px; background: var(--primary-soft); color: var(--primary-accent); border-radius: 50%; margin: 0 auto 16px auto; display: flex; align-items: center; justify-content: center; }
        .empty-title { font-size: 15px; font-weight: 600; color: var(--text-main); margin-bottom: 6px; }
        .empty-desc { font-size: 13px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5; }

        .invite-pill { display: inline-flex; align-items: center; gap: 6px; background-color: transparent; border: 1.5px solid var(--primary-accent); color: var(--primary-accent); padding: 8px 18px; border-radius: 30px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .invite-pill:hover { background-color: var(--primary-soft); }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* small helper for hidden states */
        .hidden { display: none !important; }
    </style>
</head>

<body>

    <div id="view-menu" class="app-view">
        <div class="container-top">
            <div class="header-row">
                <h1 class="header-title">Menu</h1>
                <!-- CLOSE: call closeMenu() which posts message to parent -->
                <button class="nav-btn" onclick="closeMenu()" aria-label="Close Menu">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>

            <div class="search-box" id="searchBoxContainer">
                <span class="material-symbols-rounded search-icon">search</span>
                <span class="search-prefix" id="searchPrefix">Roll –</span>
                
                <input type="tel" id="mainSearchInput" placeholder="Search any roll to check attendance" class="search-input" autocomplete="off">
                
                <div class="search-action-btn" id="actionBtn" onclick="startRollSearch()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                        <polyline points="12 5 19 12 12 19"></polyline>
                    </svg>
                </div>
            </div>
        </div>

        <div class="container-scroll" id="scrollContent">
            <div class="menu-profile-card">
                <img id="profileImage" src="Image/avatar.jpg" class="menu-profile-img" alt="Profile">
                <div class="menu-profile-info">
                    <h2 class="menu-profile-name" id="profileName">Johnathan Doe</h2>
                    <p class="menu-profile-email" id="profileEmail">john.doe23@university.edu</p>
                    
                    <div class="profile-pills">
                        <span class="pill pill-purple" id="profileRoll">Roll - 234</span>
                        <span class="pill pill-purple" id="profileClass">B.Com 1st Sem</span>
                    </div>

                    <svg id="profileEditBtn" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="edit-icon"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" /><path d="M13.5 6.5l4 4" /><path d="M16 21l5 -5" /><path d="M21 21v.01" /><path d="M16 16v.01" /></svg> 
                </div>
            </div>

            <div class="menu-card" style="margin-bottom: 20px; padding-bottom: 15px;">
                <div class="menu-header">
                    <span class="menu-header-text" id="menuCollegeLabel">Dispur College</span>
                    <span class="material-symbols-rounded" style="color: #d1d5db; font-size: 18px;">school</span>
                </div>

                <div id="subjectCard" class="menu-item active" style="padding: 14px 16px;" onclick="openSetupPage()">
                    <div class="status-dot"></div>
                    <div class="menu-icon-box purple-bg">
                        <span class="material-symbols-rounded" style="font-size: 18px;">library_add</span>
                    </div>
                    <div class="menu-text">
                        <p class="menu-title" id="subjectCardTitle">Select Subjects</p>
                        <p class="menu-subtitle" id="subjectCardSubtitle">Set up subjects to track attendance</p>
                    </div>
                    <span class="material-symbols-rounded chevron-active">chevron_right</span>
                </div>
            </div>

            <div class="menu-card">
                <a href="#" class="menu-item">
                    <span class="material-symbols-rounded menu-icon-gray">badge</span>
                    <span class="menu-item-text">Important Staff</span>
                    <span class="material-symbols-rounded chevron">chevron_right</span>
                </a>
                <div class="divider"></div>
                <a href="#" class="menu-item">
                    <span class="material-symbols-rounded menu-icon-gray">group_add</span>
                    <span class="menu-item-text">Refer a Friend</span>
                    <span class="material-symbols-rounded chevron">chevron_right</span>
                </a>
                <div class="divider"></div>
                <a href="#" class="menu-item">
                    <span class="material-symbols-rounded menu-icon-gray">chat_bubble</span>
                    <span class="menu-item-text">Report Issue</span>
                    <span class="material-symbols-rounded chevron">chevron_right</span>
                </a>
                <div class="divider"></div>
                <a href="#" class="menu-item">
                    <span class="material-symbols-rounded menu-icon-gray">gpp_maybe</span>
                    <span class="menu-item-text">Terms & Privacy</span>
                    <span class="material-symbols-rounded chevron">chevron_right</span>
                </a>
            </div>

            <div class="logout-section">
                <button id="logoutBtn" class="btn-logout">
                    <span class="material-symbols-rounded">logout</span>
                    Log Out
                </button>
                <div class="version-text">Attenza Educational • v1.0.4</div>
            </div>
        </div>
    </div>

    <div id="result-overlay-container">
        <div class="overlay-backdrop" onclick="exitSearchMode()"></div>

        <div class="result-wrapper">
            <div class="result-header">
                <span class="helper-text">Showing students from</span>
                
                <div class="dropdown-wrapper" id="classDropdown">
                    <div class="class-pill" onclick="toggleDropdown()">
                        <span id="selectedClassText">B.Com Sem 5</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    </div>

                    <div class="dropdown-list" id="classDropdownList">
                        <div class="dropdown-item" data-value="B.Com Sem 5" onclick="selectClass('B.Com Sem 5')">B.Com Sem 5</div>
                        <div class="dropdown-item" data-value="B.Com Sem 3" onclick="selectClass('B.Com Sem 3')">B.Com Sem 3</div>
                        <div class="dropdown-item" data-value="B.A. Sem 1" onclick="selectClass('B.A. Sem 1')">B.A. Sem 1</div>
                        <div class="dropdown-item" data-value="H.S. 2nd Year" onclick="selectClass('H.S. 2nd Year')">H.S. 2nd Year</div>
                    </div>
                </div>
            </div>

            <div class="result-card" id="foundState" style="display:none;">
                <div class="card-left">
                    <div class="avatar-box" id="resultAvatar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </div>
                    <div class="info-group">
                        <div class="student-name" id="resultName">Rahul Sharma</div>
                        <div class="data-freshness" id="resultFreshness">
                            <span class="status-dot-result"></span>
                            Updated just now
                        </div>
                    </div>
                </div>
                <div class="card-right">
                    <span class="percentage-val" id="resultPercent">78%</span>
                    <span class="percentage-label">Overall</span>
                </div>
            </div>

            <div class="empty-card" id="emptyState" style="display:none;">
                <div class="empty-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                </div>
                <div class="empty-title">No student found</div>
                <div class="empty-desc">Your classmates in this section are not using Attendmark yet.</div>
                
                <button class="invite-pill" onclick="inviteFriend()">
                    Invite Friend
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase + Menu logic -->
    <script type="module">
      // Firebase v10 imports (same config as other files)
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { getFirestore, doc, getDoc, collection, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Keep your firebaseConfig consistent with the rest of the app
      const firebaseConfig = {
        apiKey: "AIzaSyDbFEWKJylJJgNw0KIyFsDxlDKPwJII73o",
        authDomain: "attenza-app.firebaseapp.com",
        projectId: "attenza-app",
        storageBucket: "attenza-app.firebasestorage.app",
        messagingSenderId: "435010148378",
        appId: "1:435010148378:web:e5540806fd0ef90b16d9a3"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // DOM refs
      const profileNameEl = document.getElementById('profileName');
      const profileEmailEl = document.getElementById('profileEmail');
      const profileRollEl = document.getElementById('profileRoll');
      const profileClassEl = document.getElementById('profileClass');
      const profileImageEl = document.getElementById('profileImage');
      const menuCollegeLabel = document.getElementById('menuCollegeLabel');

      const subjectCardTitle = document.getElementById('subjectCardTitle');
      const subjectCardSubtitle = document.getElementById('subjectCardSubtitle');
      const subjectCardEl = document.getElementById('subjectCard');

      const searchInput = document.getElementById('mainSearchInput');
      const searchBox = document.getElementById('searchBoxContainer');
      const actionBtn = document.getElementById('actionBtn');
      const scrollContent = document.getElementById('scrollContent'); // This gets blurred
      const overlayContainer = document.getElementById('result-overlay-container');

      const foundStateEl = document.getElementById('foundState');
      const emptyStateEl = document.getElementById('emptyState');
      const resultNameEl = document.getElementById('resultName');
      const resultFreshnessEl = document.getElementById('resultFreshness');
      const resultPercentEl = document.getElementById('resultPercent');

      const selectedClassTextEl = document.getElementById('selectedClassText');
      const classDropdownList = document.getElementById('classDropdownList');

      const profileEditBtn = document.getElementById('profileEditBtn');
      const logoutBtn = document.getElementById('logoutBtn');

      // local cache keys
      const PROFILE_CACHE_KEY = 'att_menu_profile_cache_v1';
      const PROFILE_CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes

      // current signed in user info
      let currentUser = null;
      let currentProfile = null; // profile data from Firestore

      // Helper: post message to parent (iframe integration)
      function postToParent(msg) {
        try {
          if (window.parent && window.parent !== window) {
            window.parent.postMessage(msg, "*");
          }
        } catch (e) {
          console.warn("postMessage failed", e);
        }
      }

      // Auth watcher: populate profile when available
      onAuthStateChanged(auth, async (user) => {
        currentUser = user;
        if (!user) {
          // Clear to defaults
          setProfilePlaceholders();
          // notify parent that menu found no auth (parent should route to login)
          postToParent({ type: 'MENU_NO_AUTH' });
          return;
        }

        // Load profile: prefer cache then Firestore
        const cached = readProfileCache();
        if (cached && cached.uid === user.uid) {
          applyProfileToUI(cached.data, /*fromCache*/ true);
        } else {
          setProfilePlaceholders();
        }

        // Always try to fetch fresh profile from Firestore (non-blocking)
        try {
          const userDocRef = doc(db, 'users', user.uid);
          const snap = await getDoc(userDocRef);
          if (snap.exists()) {
            currentProfile = snap.data();
            // merge uid
            const profileData = { ...currentProfile, uid: user.uid };
            saveProfileCache(profileData);
            applyProfileToUI(profileData, /*fromCache*/ false);
          } else {
            // no user doc yet (maybe profile not complete)
            setProfilePlaceholders({ email: user.email, name: user.displayName || '' });
            // let parent handle showing registration if needed
            postToParent({ type: 'MENU_AUTH_NO_PROFILE', uid: user.uid });
          }
        } catch (e) {
          console.error("Failed to fetch user profile:", e);
        }
      });

      // Set friendly placeholders when no profile available
      function setProfilePlaceholders(pre = {}) {
        profileNameEl.textContent = pre.name || "Guest User";
        profileEmailEl.textContent = pre.email || "Not signed in";
        profileRollEl.textContent = "Roll - —";
        profileClassEl.textContent = "Class - —";
        profileImageEl.src = getDefaultDp();
        menuCollegeLabel.textContent = "College";
        subjectCardTitle.textContent = "Select Subjects";
        subjectCardSubtitle.textContent = "Set up subjects to track attendance";
      }

      function getDefaultDp() {
        // Use local asset if present; fallback to neutral avatar
        return "./Image/default-profile.png"; // if not present, browser will try; UI already uses an unsplash fallback
      }

      function applyProfileToUI(profile, fromCache=false) {
        if (!profile) return;
        // fields we expect: name, email, rollNumber, college, course_or_class, section
        profileNameEl.textContent = profile.name || (currentUser && currentUser.displayName) || "Student";
        profileEmailEl.textContent = profile.email || (currentUser && currentUser.email) || "";
        profileRollEl.textContent = profile.rollNumber ? `Roll - ${profile.rollNumber}` : "Roll - —";
        const classText = profile.course_or_class ? `${profile.course_or_class}${profile.section ? ' · ' + profile.section : ''}` : "Class - —";
        profileClassEl.textContent = classText;
        menuCollegeLabel.textContent = profile.college || "College";
        // profile picture - if user has e.g. photoURL in profile use it. Otherwise keep default.
        if (profile.photoURL) {
          profileImageEl.src = profile.photoURL;
        } else if (currentUser && currentUser.photoURL) {
          profileImageEl.src = currentUser.photoURL;
        } else {
          // keep existing src; try default
          profileImageEl.src = getDefaultDp();
        }

        // If user has selected subjects (either in a field or a subcollection indicator), change subject card copy.
        // We'll check a few plausible places:
        let subjectsExist = false;
        if (Array.isArray(profile.selectedSubjects) && profile.selectedSubjects.length > 0) subjectsExist = true;
        if (profile.subjectCount && Number(profile.subjectCount) > 0) subjectsExist = true;
        // fallback: if there's a 'majors' or 'subjects' field
        if (profile.majors && Array.isArray(profile.majors) && profile.majors.length > 0) subjectsExist = true;

        if (subjectsExist) {
          subjectCardTitle.textContent = "Your Subjects";
          subjectCardSubtitle.textContent = "Manage subjects to track attendance";
        } else {
          subjectCardTitle.textContent = "Select Subjects";
          subjectCardSubtitle.textContent = "Set up subjects to track attendance";
        }

        // Store currentProfile
        currentProfile = profile;

        // Update the default scope in the dropdown to user's class if available
        if (profile.course_or_class) {
          selectedClassTextEl.textContent = profile.course_or_class + (profile.section ? ' · ' + profile.section : '');
        }
      }

      // Save profile to localStorage cache
      function saveProfileCache(profileObj) {
        try {
          const payload = { uid: profileObj.uid || (currentUser && currentUser.uid), ts: Date.now(), data: profileObj };
          localStorage.setItem(PROFILE_CACHE_KEY, JSON.stringify(payload));
        } catch (e) { console.warn("Profile cache save failed", e); }
      }

      // Read profile cache if still fresh
      function readProfileCache() {
        try {
          const raw = localStorage.getItem(PROFILE_CACHE_KEY);
          if (!raw) return null;
          const obj = JSON.parse(raw);
          if (!obj || !obj.ts) return null;
          if ((Date.now() - obj.ts) > PROFILE_CACHE_TTL_MS) {
            localStorage.removeItem(PROFILE_CACHE_KEY);
            return null;
          }
          return obj;
        } catch (e) {
          console.warn("Profile cache read failed", e);
          return null;
        }
      }

      // Open setup page: send message to parent so the parent app can route/handle navigation
      function openSetupPage() {
        postToParent({ type: "NAVIGATE", to: "setup" });
      }

      // Profile edit button -> notify parent to open profile edit (no UI changes inside iframe)
      profileEditBtn.addEventListener('click', () => {
        postToParent({ type: "NAVIGATE", to: "edit_profile" });
      });

      // Logout
      logoutBtn.addEventListener('click', async () => {
        try {
          await signOut(auth);
          // Notify parent to update UI / redirect to login
          postToParent({ type: "USER_SIGNED_OUT" });
        } catch (e) {
          console.error("Sign out failed", e);
        }
      });

      // Dropdown handling
      function toggleDropdown() {
        document.getElementById('classDropdown').classList.toggle('active');
      }

      function selectClass(className) {
        selectedClassTextEl.textContent = className;
        document.getElementById('classDropdown').classList.remove('active');

        // If user selected a class from dropdown, re-run last search if any
        // No auto-fetch by default; user must input roll then press search
      }

      document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('classDropdown');
        if (dropdown && !dropdown.contains(event.target) && !event.target.closest('.class-pill')) {
          dropdown.classList.remove('active');
        }
      });

      // Input logic for search field
      if (searchInput) {
        searchInput.addEventListener('focus', () => {
          searchBox.classList.add('active');
        });

        searchInput.addEventListener('blur', () => {
          if (searchInput.value.length === 0) {
            searchBox.classList.remove('active');
          }
        });

        searchInput.addEventListener('input', (e) => {
          // Strictly numeric: roll numbers
          const val = e.target.value.replace(/[^0-9]/g, '');
          e.target.value = val;

          if (val.length > 0) {
            actionBtn.classList.add('visible');
          } else {
            actionBtn.classList.remove('visible');
          }
        });
      }

      // Start roll search: UI + DB query
      async function startRollSearch() {
        const roll = (searchInput && searchInput.value && searchInput.value.trim()) ? searchInput.value.trim() : null;
        if (!roll) {
          // nothing to do but open overlay
          activateSearchMode();
          return;
        }

        // Activate overlay & blur UI
        activateSearchMode();

        // Build query scope: default to currentProfile college & class; if not available, only roll filter (broad)
        let college = currentProfile && currentProfile.college ? currentProfile.college : null;
        let course_or_class = currentProfile && currentProfile.course_or_class ? currentProfile.course_or_class : null;

        // If the user changed selectedClassText to some custom string, try to use that (simple heuristic)
        const selectedClassText = selectedClassTextEl.textContent;
        if (selectedClassText && selectedClassText !== "" && selectedClassText !== "Select class") {
          // attempt to parse primary token (e.g., "B.Com Sem 5" -> use as course_or_class)
          course_or_class = selectedClassText;
        }

        try {
          // Query users collection: where rollNumber == roll AND college == college AND course_or_class == course_or_class
          // Firestore requires composite indexes for multiple where clauses in some combinations; this query is standard and should work if fields are indexed.
          const usersCol = collection(db, 'users');

          let q;
          if (college && course_or_class) {
            q = query(usersCol, where('rollNumber', '==', roll), where('college', '==', college), where('course_or_class', '==', course_or_class), limit(1));
          } else if (college) {
            q = query(usersCol, where('rollNumber', '==', roll), where('college', '==', college), limit(1));
          } else {
            q = query(usersCol, where('rollNumber', '==', roll), limit(1));
          }

          const qsnap = await getDocs(q);
          if (qsnap.empty) {
            // nothing found
            showEmptyState();
            return;
          }

          // we have at least one match: take the first
          const foundDoc = qsnap.docs[0];
          const foundData = foundDoc.data();
          const foundUid = foundDoc.id;

          // populate result card
          fillResultCard(foundUid, foundData);
        } catch (err) {
          console.error("Roll search failed", err);
          // On error, show empty state
          showEmptyState();
        }
      }

      // Activate search mode visually
      function activateSearchMode() {
        scrollContent.classList.add('content-blurred');
        overlayContainer.style.display = 'flex';
        if (searchInput) searchInput.blur();
      }

      // Exit search mode
      function exitSearchMode() {
        scrollContent.classList.remove('content-blurred');
        overlayContainer.style.display = 'none';
        if (searchInput) {
          searchInput.value = '';
          searchBox.classList.remove('active');
        }
        actionBtn.classList.remove('visible');
        // hide results
        foundStateEl.style.display = 'none';
        emptyStateEl.style.display = 'none';
      }

      // Show empty state
      function showEmptyState() {
        foundStateEl.style.display = 'none';
        emptyStateEl.style.display = 'block';
      }

      // Fetch and display summary for a user (robust: tries multiple possible doc locations)
      async function fetchSummaryForUserUid(uid) {
        // Try common places for a "summary" document:
        // 1) users/{uid}/summary (doc named 'summary' inside subcollection 'summary')
        // 2) users/{uid}/summary (document id 'summary' directly under user path — implemented as subcollection)
        // 3) fallback to fields inside users/{uid} like overallPercent / totalClasses / attendedClasses
        // We'll attempt doc(db, 'users', uid, 'summary', 'summary') and doc(db,'users', uid, 'summary')
        try {
          // attempt sub-doc path: users/{uid}/summary/summary
          const tryPaths = [
            ["users", uid, "summary", "summary"],
            ["users", uid, "summary"], // if you used doc('users', uid, 'summary') as a document id (rare)
            ["users", uid] // fallback to main user doc fields
          ];

          for (const path of tryPaths) {
            try {
              const ref = doc(db, ...path);
              const s = await getDoc(ref);
              if (s.exists()) {
                // return document data plus doc metadata
                return { docId: s.id, data: s.data(), path: path.join('/') };
              }
            } catch (innerErr) {
              // ignore and continue trying other paths
            }
          }
        } catch (e) {
          console.warn("fetchSummaryForUserUid error:", e);
        }
        return null;
      }

      // Compute a usable overall percent from summary-like data
      function computePercentFromSummary(summaryObj) {
        if (!summaryObj) return { percent: null, updatedAtText: null };

        const d = summaryObj.data || {};
        // direct overallPercent
        if (typeof d.overallPercent === 'number') {
          const tsText = d.updatedAt ? relativeTimeFromTimestamp(d.updatedAt) : 'Updated just now';
          return { percent: Math.round(d.overallPercent), updatedAtText: tsText };
        }

        // total/attended fields
        const attended = (typeof d.attendedClasses === 'number') ? d.attendedClasses : (typeof d.attended === 'number' ? d.attended : null);
        const total = (typeof d.totalClasses === 'number') ? d.totalClasses : (typeof d.total === 'number' ? d.total : null);
        if (attended !== null && total !== null && total > 0) {
          const percent = Math.round((attended / total) * 100);
          const tsText = d.updatedAt ? relativeTimeFromTimestamp(d.updatedAt) : 'Updated just now';
          return { percent, updatedAtText: tsText };
        }

        // fallback: try if user doc contains small summary fields (e.g., overall)
        if (typeof d.overall === 'number') {
          return { percent: Math.round(d.overall), updatedAtText: d.updatedAt ? relativeTimeFromTimestamp(d.updatedAt) : 'Updated just now' };
        }

        return { percent: null, updatedAtText: null };
      }

      // Convert Firestore serverTimestamp or JS Date to relative string
      function relativeTimeFromTimestamp(ts) {
        try {
          // ts may be a JS Date, string, number, or Firestore Timestamp-like object { seconds, nanoseconds }
          let date;
          if (!ts) return 'Updated just now';
          if (ts.seconds && typeof ts.seconds === 'number') {
            date = new Date(ts.seconds * 1000);
          } else if (typeof ts.toDate === 'function') {
            date = ts.toDate();
          } else {
            date = new Date(ts);
          }
          const diff = Date.now() - date.getTime();
          const minutes = Math.floor(diff / 60000);
          if (minutes < 1) return 'Updated just now';
          if (minutes < 60) return `Updated ${minutes}m ago`;
          const hours = Math.floor(minutes / 60);
          if (hours < 24) return `Updated ${hours}h ago`;
          const days = Math.floor(hours / 24);
          return `Updated ${days}d ago`;
        } catch (e) {
          return 'Updated';
        }
      }

      // Fill the found result card (reads summary if available)
      async function fillResultCard(foundUid, foundData) {
        try {
          const displayName = foundData.name || foundData.displayName || (foundData.email ? foundData.email.split('@')[0] : 'Student');
          resultNameEl.textContent = displayName;

          // Try to get summary
          const summaryObj = await fetchSummaryForUserUid(foundUid);
          const computed = computePercentFromSummary(summaryObj);

          if (computed && computed.percent !== null) {
            resultPercentEl.textContent = computed.percent + "%";
            resultFreshnessEl.textContent = computed.updatedAtText || "Updated just now";
          } else {
            // No computed percent: show fallback
            resultPercentEl.textContent = "—";
            // if foundData has updatedAt
            const updatedAt = foundData.updatedAt || foundData.updatedAtAt || null;
            resultFreshnessEl.textContent = updatedAt ? relativeTimeFromTimestamp(updatedAt) : 'Updated just now';
          }

          // If foundData.email or photo exist, optionally show them (we only update the name / percent)
          foundStateEl.style.display = 'flex';
          emptyStateEl.style.display = 'none';
        } catch (e) {
          console.error("fillResultCard failed", e);
          showEmptyState();
        }
      }

      // Invite friend (simple action: tell parent to handle invite)
      function inviteFriend() {
        postToParent({ type: 'INVITE_FRIEND' });
      }

      // Close menu (postMessage to parent)
      function closeMenu() {
        try {
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: "CLOSE_MENU" }, "*");
          } else {
            const overlay = document.getElementById('view-menu');
            if (overlay) overlay.style.display = 'none';
          }
        } catch (e) {
          const overlay = document.getElementById('view-menu');
          if (overlay) overlay.style.display = 'none';
        }
      }

      // Expose functions globally used by UI elements in the HTML (existing handlers)
      window.toggleDropdown = toggleDropdown;
      window.selectClass = selectClass;
      window.startRollSearch = startRollSearch;
      window.activateSearchMode = activateSearchMode;
      window.exitSearchMode = exitSearchMode;
      window.openSetupPage = openSetupPage;
      window.closeMenu = closeMenu;
      window.inviteFriend = inviteFriend;

      // Safety: if script loads while user already signed in, try to populate via cached profile
      (function tryApplyCachedProfileImmediately() {
        const c = readProfileCache();
        if (c && c.data) {
          applyProfileToUI(c.data, true);
        }
      })();

    </script>
</body>
</html>
